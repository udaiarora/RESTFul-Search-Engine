<HTML>
<HEAD>
<TITLE>The LAG and DIF Functions</TITLE>
<LINK REL="STYLESHEET" TYPE="text/css" HREF="../sas.css">
</HEAD>
<BODY BGCOLOR="#FFFFFF" TEXT="#000000">
<!--Navigation Panel-->
<TABLE BORDER="0" CELLPADDING="0">
<TR VALIGN="TOP">
  <TD ALIGN="CENTER">
  <A NAME="topofpage" HREF="index.htm">
  <IMG BORDER="0" SRC="../../common/images/cont1.gif" ALT="Chapter Contents" WIDTH="99" HEIGHT="16"><BR><FONT SIZE="-2">Chapter Contents</FONT></A></TD>
  <TD ALIGN=CENTER>
  <A HREF="sect45.htm"><IMG BORDER="0" SRC="../../common/images/prev1.gif" ALT="Previous" WIDTH="99" HEIGHT="16"><BR><FONT SIZE="-2">Previous</FONT></A></TD>
  <TD ALIGN=CENTER>
  <A HREF="sect47.htm"><IMG BORDER="0" SRC="../../common/images/next1.gif" ALT="Next" WIDTH="99" HEIGHT="16"><BR><FONT SIZE="-2">Next</FONT></A></TD>
</TR>
</TABLE>
<TABLE BGCOLOR="#CCCC99" WIDTH="100%" CELLPADDING=4>
<TR>
  <TD VALIGN=MIDDLE CLASS="chaphead"><I><FONT SIZE="2">Working with Time Series Data</FONT></I></TD>
</TR>
</TABLE><BR>
<P><!--End of Navigation Panel-->
<H2>The LAG and DIF Functions  </H2>
<P><A NAME="idxtsd0364">&#13;</A><A NAME="idxtsd0365">&#13;</A><A NAME="idxtsd0367">&#13;</A><A NAME="idxtsd0366">&#13;</A><A NAME="idxtsd0369">&#13;</A><A NAME="idxtsd0368">&#13;</A><A NAME="idxtsd0371">&#13;</A><A NAME="idxtsd0370">&#13;</A><A NAME="idxtsd0373">&#13;</A><A NAME="idxtsd0372">&#13;</A><A NAME="idxtsd0375">&#13;</A><A NAME="idxtsd0374">&#13;</A><A NAME="idxtsd0377">&#13;</A><A NAME="idxtsd0376">&#13;</A>The DATA step provides two functions, LAG and DIF,
for accessing previous values of a variable or expression.
These functions are useful for computing lags and differences of series.
<P>For example, the following statements add the variables CPILAG
and CPIDIF to the USCPI data set.
The variable CPILAG contains lagged values of the CPI series.
The variable CPIDIF contains the changes of the CPI series from
the previous period; that is, CPIDIF is CPI minus CPILAG.
The new data set is shown in part in <A HREF="sect46.htm#tsdf21">Figure 2.20</A>.
<P><PRE>
   data uscpi;
      set uscpi;
      cpilag = lag( cpi );
      cpidif = dif( cpi );
   run;
   
   proc print data=uscpi;
   run;
</PRE>
<P><A NAME="tsdf21">&#13;</A><CENTER>
         <TABLE BORDER="1" WIDTH="95%" CELLPADDING="10" CELLSPACING="0"
          RULES="GROUPS" FRAME="BOX" BGCOLOR="#F0F0F0" 
          BORDERCOLOR="#000000">
          <TR><TD ALIGN="CENTER" VALIGN="MIDDLE" BGCOLOR="#F0F0F0"><A NAME="IDX">&nbsp;</A>
<CENTER>
<!--BEGINTABLE--> 
<TABLE  cellspacing=1 cellpadding=7 rules=GROUPS frame=BOX border=1>
<thead>
<TR>
 <TD ALIGN=CENTER bgcolor="#AAAAAA"><font  face="Verdana, Helvetica, Helv" size="2" color="#0033AA"><b>Obs</b></font></TD>
 <TD ALIGN=CENTER bgcolor="#AAAAAA"><font  face="Verdana, Helvetica, Helv" size="2" color="#0033AA"><b>date</b></font></TD>
 <TD ALIGN=CENTER bgcolor="#AAAAAA"><font  face="Verdana, Helvetica, Helv" size="2" color="#0033AA"><b>cpi</b></font></TD>
 <TD ALIGN=CENTER bgcolor="#AAAAAA"><font  face="Verdana, Helvetica, Helv" size="2" color="#0033AA"><b>cpilag</b></font></TD>
 <TD ALIGN=CENTER bgcolor="#AAAAAA"><font  face="Verdana, Helvetica, Helv" size="2" color="#0033AA"><b>cpidif</b></font></TD>
</TR>
</thead>
<tbody>
<TR>
 <TD ALIGN=RIGHT bgcolor="#CCCCCC"><font  face="Verdana, Helvetica, Helv" size="2" color="#000000"> 1</font></TD>
 <TD ALIGN=RIGHT bgcolor="#CCCCCC"><font  face="Verdana, Helvetica, Helv" size="2" color="#000000">JUN90</font></TD>
 <TD ALIGN=RIGHT bgcolor="#CCCCCC"><font  face="Verdana, Helvetica, Helv" size="2" color="#000000">129.9</font></TD>
 <TD ALIGN=RIGHT bgcolor="#CCCCCC"><font  face="Verdana, Helvetica, Helv" size="2" color="#000000">   . </font></TD>
 <TD ALIGN=RIGHT bgcolor="#CCCCCC"><font  face="Verdana, Helvetica, Helv" size="2" color="#000000"> . </font></TD>
</TR>
<TR>
 <TD ALIGN=RIGHT bgcolor="#CCCCCC"><font  face="Verdana, Helvetica, Helv" size="2" color="#000000"> 2</font></TD>
 <TD ALIGN=RIGHT bgcolor="#CCCCCC"><font  face="Verdana, Helvetica, Helv" size="2" color="#000000">JUL90</font></TD>
 <TD ALIGN=RIGHT bgcolor="#CCCCCC"><font  face="Verdana, Helvetica, Helv" size="2" color="#000000">130.4</font></TD>
 <TD ALIGN=RIGHT bgcolor="#CCCCCC"><font  face="Verdana, Helvetica, Helv" size="2" color="#000000">129.9</font></TD>
 <TD ALIGN=RIGHT bgcolor="#CCCCCC"><font  face="Verdana, Helvetica, Helv" size="2" color="#000000">0.5</font></TD>
</TR>
<TR>
 <TD ALIGN=RIGHT bgcolor="#CCCCCC"><font  face="Verdana, Helvetica, Helv" size="2" color="#000000"> 3</font></TD>
 <TD ALIGN=RIGHT bgcolor="#CCCCCC"><font  face="Verdana, Helvetica, Helv" size="2" color="#000000">AUG90</font></TD>
 <TD ALIGN=RIGHT bgcolor="#CCCCCC"><font  face="Verdana, Helvetica, Helv" size="2" color="#000000">131.6</font></TD>
 <TD ALIGN=RIGHT bgcolor="#CCCCCC"><font  face="Verdana, Helvetica, Helv" size="2" color="#000000">130.4</font></TD>
 <TD ALIGN=RIGHT bgcolor="#CCCCCC"><font  face="Verdana, Helvetica, Helv" size="2" color="#000000">1.2</font></TD>
</TR>
<TR>
 <TD ALIGN=RIGHT bgcolor="#CCCCCC"><font  face="Verdana, Helvetica, Helv" size="2" color="#000000"> 4</font></TD>
 <TD ALIGN=RIGHT bgcolor="#CCCCCC"><font  face="Verdana, Helvetica, Helv" size="2" color="#000000">SEP90</font></TD>
 <TD ALIGN=RIGHT bgcolor="#CCCCCC"><font  face="Verdana, Helvetica, Helv" size="2" color="#000000">132.7</font></TD>
 <TD ALIGN=RIGHT bgcolor="#CCCCCC"><font  face="Verdana, Helvetica, Helv" size="2" color="#000000">131.6</font></TD>
 <TD ALIGN=RIGHT bgcolor="#CCCCCC"><font  face="Verdana, Helvetica, Helv" size="2" color="#000000">1.1</font></TD>
</TR>
<TR>
 <TD ALIGN=RIGHT bgcolor="#CCCCCC"><font  face="Verdana, Helvetica, Helv" size="2" color="#000000"> 5</font></TD>
 <TD ALIGN=RIGHT bgcolor="#CCCCCC"><font  face="Verdana, Helvetica, Helv" size="2" color="#000000">OCT90</font></TD>
 <TD ALIGN=RIGHT bgcolor="#CCCCCC"><font  face="Verdana, Helvetica, Helv" size="2" color="#000000">133.5</font></TD>
 <TD ALIGN=RIGHT bgcolor="#CCCCCC"><font  face="Verdana, Helvetica, Helv" size="2" color="#000000">132.7</font></TD>
 <TD ALIGN=RIGHT bgcolor="#CCCCCC"><font  face="Verdana, Helvetica, Helv" size="2" color="#000000">0.8</font></TD>
</TR>
<TR>
 <TD ALIGN=RIGHT bgcolor="#CCCCCC"><font  face="Verdana, Helvetica, Helv" size="2" color="#000000"> 6</font></TD>
 <TD ALIGN=RIGHT bgcolor="#CCCCCC"><font  face="Verdana, Helvetica, Helv" size="2" color="#000000">NOV90</font></TD>
 <TD ALIGN=RIGHT bgcolor="#CCCCCC"><font  face="Verdana, Helvetica, Helv" size="2" color="#000000">133.8</font></TD>
 <TD ALIGN=RIGHT bgcolor="#CCCCCC"><font  face="Verdana, Helvetica, Helv" size="2" color="#000000">133.5</font></TD>
 <TD ALIGN=RIGHT bgcolor="#CCCCCC"><font  face="Verdana, Helvetica, Helv" size="2" color="#000000">0.3</font></TD>
</TR>
<TR>
 <TD ALIGN=RIGHT bgcolor="#CCCCCC"><font  face="Verdana, Helvetica, Helv" size="2" color="#000000"> 7</font></TD>
 <TD ALIGN=RIGHT bgcolor="#CCCCCC"><font  face="Verdana, Helvetica, Helv" size="2" color="#000000">DEC90</font></TD>
 <TD ALIGN=RIGHT bgcolor="#CCCCCC"><font  face="Verdana, Helvetica, Helv" size="2" color="#000000">133.8</font></TD>
 <TD ALIGN=RIGHT bgcolor="#CCCCCC"><font  face="Verdana, Helvetica, Helv" size="2" color="#000000">133.8</font></TD>
 <TD ALIGN=RIGHT bgcolor="#CCCCCC"><font  face="Verdana, Helvetica, Helv" size="2" color="#000000">0.0</font></TD>
</TR>
<TR>
 <TD ALIGN=RIGHT bgcolor="#CCCCCC"><font  face="Verdana, Helvetica, Helv" size="2" color="#000000"> 8</font></TD>
 <TD ALIGN=RIGHT bgcolor="#CCCCCC"><font  face="Verdana, Helvetica, Helv" size="2" color="#000000">JAN91</font></TD>
 <TD ALIGN=RIGHT bgcolor="#CCCCCC"><font  face="Verdana, Helvetica, Helv" size="2" color="#000000">134.6</font></TD>
 <TD ALIGN=RIGHT bgcolor="#CCCCCC"><font  face="Verdana, Helvetica, Helv" size="2" color="#000000">133.8</font></TD>
 <TD ALIGN=RIGHT bgcolor="#CCCCCC"><font  face="Verdana, Helvetica, Helv" size="2" color="#000000">0.8</font></TD>
</TR>
</tbody>
</TABLE>
<!--ENDTABLE--></CENTER>
</TD></TR></TABLE></CENTER><SPAN CLASS="ssften"><B>Figure 2.20:</B> USCPI Data Set with Lagged and Differenced Series</SPAN><P>
<P><H3><I>Understanding the DATA Step LAG and DIF Functions</I></H3>
<A NAME="idxtsd0379">&#13;</A><A NAME="idxtsd0378">&#13;</A><A NAME="idxtsd0381">&#13;</A><A NAME="idxtsd0380">&#13;</A><A NAME="idxtsd0383">&#13;</A><A NAME="idxtsd0382">&#13;</A><A NAME="idxtsd0385">&#13;</A><A NAME="idxtsd0384">&#13;</A><A NAME="idxtsd0387">&#13;</A><A NAME="idxtsd0386">&#13;</A><A NAME="idxtsd0389">&#13;</A><A NAME="idxtsd0388">&#13;</A>When used in this simple way,
LAG and DIF act as lag and difference functions.
However, it is important to keep in mind that, despite their names,
the LAG and DIF functions available in the DATA step are not
true lag and difference functions.
<P>Rather, LAG and DIF are queuing functions that remember and
return argument values from previous calls.
The LAG function remembers the value you pass to it
and returns as its result the value you passed to it on the
previous call.
The DIF function works the same way but returns the difference
between the current argument and the remembered value.
(LAG and DIF return a missing value the first time the function is called.)
<P>A true lag function does not return the value of the argument for the
&#34;previous call,&#34; as do the DATA step LAG and DIF functions.
Instead, a true lag function returns the value of its argument for the
&#34;previous observation,&#34; regardless of the sequence of previous calls
to the function.
Thus, for a true lag function to be possible, it must be clear what
the &#34;previous observation&#34; is.
<P>If the data are sorted chronologically, then LAG and DIF act as true
lag and difference functions.  If in doubt, use PROC SORT to sort
your data prior to using the LAG and DIF functons.  Beware of missing
observations, which may cause LAG and DIF to return values that are
not the actual lag and difference values
<P>The DATA step is a powerful tool that can read any number of
observations from any number of input files or data sets,
can create any number of output data sets,
and can write any number of output observations
to any of the output data sets, all in the same program.
Thus, in general, it is not clear what &#34;previous observation&#34;
means in a DATA step program.
In a DATA step program, the &#34;previous observation&#34; exists only
if you write the program in a simple way that makes this concept meaningful.
<P>Since, in general, the previous observation is not clearly defined,
it is not possible to make true lag or difference functions for the
DATA step.
Instead, the DATA step provides queuing functions that
make it easy to compute lags and differences.
<P><H3><I>Pitfalls of DATA Step LAG and DIF Functions</I></H3>
<A NAME="idxtsd0391">&#13;</A><A NAME="idxtsd0390">&#13;</A><A NAME="idxtsd0393">&#13;</A><A NAME="idxtsd0392">&#13;</A><A NAME="idxtsd0395">&#13;</A><A NAME="idxtsd0394">&#13;</A><A NAME="idxtsd0397">&#13;</A><A NAME="idxtsd0396">&#13;</A><A NAME="idxtsd0399">&#13;</A><A NAME="idxtsd0398">&#13;</A><A NAME="idxtsd0401">&#13;</A><A NAME="idxtsd0400">&#13;</A>The LAG and DIF functions compute lags and differences
provided that the sequence of calls to the function corresponds
to the sequence of observations in the output data set.
However, any complexity in the DATA step that breaks
this correspondence causes the LAG and DIF functions to
produce unexpected results.
<P>For example, suppose you want to add the variable CPILAG
to the USCPI data set, as in the previous example,
and you also want to subset the series to 1991 and later years.
You might use the following statements:
<P><PRE>
   data subset;
      set uscpi;
      if date &#62;= '1jan1991'd;
      cpilag = lag( cpi );  /* WRONG PLACEMENT! */
   run;
</PRE>
<P>If the subsetting IF statement comes before the LAG
function call, the value of CPILAG will be missing for January 1991,
even though a value for December 1990 is available in the USCPI data set.
To avoid losing this value, you must rearrange the statements to
ensure that the LAG function is actually executed for the December 1990
observation.
<P><PRE>
   data subset;
      set uscpi;
      cpilag = lag( cpi );
      if date &#62;= '1jan1991'd;
   run;
</PRE>
<P>In other cases, the subsetting statement should come before
the LAG and DIF functions.
For example, the following statements subset the FOREOUT data set
shown in a previous example to select only _TYPE_=RESIDUAL observations
and also to compute the variable LAGRESID.
<P><PRE>
   data residual;
      set foreout;
      if _type_ = &#34;RESIDUAL&#34;;
      lagresid = lag( cpi );
   run;
</PRE>
<P>Another pitfall of LAG and DIF functions arises
when they are used to process time series cross-sectional data sets.
For example, suppose you want to add the variable CPILAG
to the CPICITY data set shown in a previous example.
You might use the following statements:
<P><PRE>
   data cpicity;
      set cpicity;
      cpilag = lag( cpi );
   run;
</PRE>
<P>However, these statements do not yield the desired result.
In the data set produced by these statements,
the value of CPILAG for the first observation for the first city is missing
(as it should be), but in the first observation for all later cities,
CPILAG contains the last value for the previous city.
To correct this, set the lagged variable to missing at the start of
each cross section, as follows:
<P><PRE>
   data cpicity;
      set cpicity;
      by city date;
      cpilag = lag( cpi );
      if first.city then cpilag = .;
   run;
</PRE>
<P><H3><I>Alternatives to LAG and DIF Functions</I></H3>
<A NAME="idxtsd0403">&#13;</A><A NAME="idxtsd0402">&#13;</A><A NAME="idxtsd0405">&#13;</A><A NAME="idxtsd0404">&#13;</A><A NAME="idxtsd0407">&#13;</A><A NAME="idxtsd0406">&#13;</A><A NAME="idxtsd0409">&#13;</A><A NAME="idxtsd0408">&#13;</A><A NAME="idxtsd0411">&#13;</A><A NAME="idxtsd0410">&#13;</A><A NAME="idxtsd0413">&#13;</A><A NAME="idxtsd0412">&#13;</A><A NAME="idxtsd0415">&#13;</A><A NAME="idxtsd0414">&#13;</A>You can also calculate lags and differences in the DATA step
without using LAG and DIF functions.
For example, the following statements add the variables CPILAG
and CPIDIF to the USCPI data set:
<P><PRE>
   data uscpi;
      set uscpi;
      retain cpilag;
      cpidif = cpi - cpilag;
      output;
      cpilag = cpi;
   run;
</PRE>
<P>The RETAIN statement prevents the DATA step from reinitializing
CPILAG to a missing value at the start of each iteration and thus allows
CPILAG to retain the value of CPI assigned to it in the last statement.
The OUTPUT statement causes the output observation to contain
values of the variables before CPILAG is reassigned the current value of CPI
in the last statement.  This is the approach that must be used if you
want to build a variable that is a function of its previous lags.
<P>You can also use the EXPAND procedure to compute lags and differences.
For example,
the following statements compute lag and difference variables for CPI:
<P><PRE>
   proc expand data=uscpi out=uscpi method=none;
      id date;
      convert cpi=cpilag / transform=( lag 1 );
      convert cpi=cpidif / transform=( dif 1 );
   run;
</PRE>
<P><H3><I>LAG and DIF Functions in PROC MODEL</I></H3>
<A NAME="idxtsd0416">&#13;</A><A NAME="idxtsd0417">&#13;</A><A NAME="idxtsd0419">&#13;</A><A NAME="idxtsd0418">&#13;</A><A NAME="idxtsd0421">&#13;</A><A NAME="idxtsd0420">&#13;</A><A NAME="idxtsd0423">&#13;</A><A NAME="idxtsd0422">&#13;</A><A NAME="idxtsd0425">&#13;</A><A NAME="idxtsd0424">&#13;</A><A NAME="idxtsd0427">&#13;</A><A NAME="idxtsd0426">&#13;</A><A NAME="idxtsd0429">&#13;</A><A NAME="idxtsd0428">&#13;</A>The preceding discussion of LAG and DIF functions applies to
LAG and DIF functions available in the DATA step.
However, LAG and DIF functions are also used in the MODEL procedure.
<P>The MODEL procedure LAG and DIF functions do not work
like the DATA step LAG and DIF functions.
The LAG and DIF functions supported by PROC MODEL
are true lag and difference functions, not queuing functions.
<P>Unlike the DATA step, the MODEL procedure processes
observations from a single input data set, so the
&#34;previous observation&#34; is always clearly defined in a PROC MODEL program.
Therefore, PROC MODEL is able to define LAG and DIF as true lagging
functions that operate on values from the previous observation.
See <A HREF="../chap14/index.htm">Chapter 14, &#34;The MODEL Procedure,&#34;</A> for more information on LAG and DIF functions
in the MODEL procedure.
<P>
<!--Navigation Panel-->
<TABLE BORDER="0" CELLPADDING="0">
<TR VALIGN="TOP">
  <TD ALIGN="CENTER">
  <A HREF="index.htm">
  <IMG BORDER="0" SRC="../../common/images/cont1.gif" ALT="Chapter Contents" WIDTH="99" HEIGHT="16"><BR><FONT SIZE="-2">Chapter Contents</FONT></A></TD>
  <TD ALIGN=CENTER>
  <A HREF="sect45.htm"><IMG BORDER="0" SRC="../../common/images/prev1.gif" ALT="Previous" WIDTH="99" HEIGHT="16"><BR><FONT SIZE="-2">Previous</FONT></A></TD>
  <TD ALIGN=CENTER>
  <A HREF="sect47.htm"><IMG BORDER="0" SRC="../../common/images/next1.gif" ALT="Next" WIDTH="99" HEIGHT="16"><BR><FONT SIZE="-2">Next</FONT></A></TD>
  <TD ALIGN=CENTER>
  <A HREF="#topofpage">
  <IMG BORDER="0" SRC="../../common/images/top1.gif" ALT="Top" WIDTH="99" HEIGHT="16"><BR><FONT SIZE="-2">Top</FONT></A></TD>
</TR>
</TABLE>
<P><!--End of Navigation Panel-->
<P><FONT SIZE="1"><A HREF="../../common/images/copyrite.htm">Copyright &copy; 1999 by SAS Institute Inc., Cary, NC, USA. All rights reserved.</A></FONT>
</BODY>
</HTML>
